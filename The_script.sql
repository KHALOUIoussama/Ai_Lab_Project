SET NOCOUNT ON

-- Declare the variables
DECLARE @ResultCurveId uniqueidentifier

-- Create a temporary table to store the results
CREATE TABLE #ResultsTable (ResultCurve_id varchar(50), n int, xtime float , xvalue float)

SELECT distinct resultcurve_id, OrderNo, Batch, unique_code as Sample_Code
INTO #Resultcurve_id_table
FROM ResultCurve
         JOIN vwResultDetail on ResultCurve.result_id = vwResultDetail.result_id
WHERE ResultCurve.variable_id = '8AE2CDE9-0986-47A7-8DC1-F9C56AD2C87B' --selectionner les courbes Torque
  and ResultCurve.result_id IN (select distinct result_id from vwResultDetail
                                where Test='MDR 200C' and Status != 'Ignored' and specification not like '7%'and OrderNo IN (N'MX12404177E201', N'MX324060823CV01', N'MX124022516FX01', N'MX124061521J201', N'MX124053158201', N'MX224061220GV01', N'MX124011912R601', N'MX22404216RD01', N'MX124041915FV01', N'MX224041017M801', N'MX22405318B001', N'MX324060412BP01', N'MX224042316SK01', N'MX224010616FO01', N'MX224020720UV01', N'MX124030920NQ01', N'MX1240210126Y01', N'MX32403305H601', N'MX124022718H401', N'MX224061710JB01', N'MX12405125VH01', N'MX124010614H401', N'MX12405168Y801', N'MX123122719C801', N'MX32401193IO01', N'MX3240525127601', N'MX12404214H701', N'MX32402034QH01', N'MX124022815HP01', N'MX22404290V801', N'MX12403222WB01', N'MX224011423JN01', N'MX22406173J701', N'MX2240304104U01', N'MX224051020H01', N'MX224060611DO01', N'MX224021215X301', N'MX224011014HM01', N'MX32404044IV01', N'MX124060511BJ01', N'MX124010923JP01', N'MX12402217DB01', N'MX324021122V601', N'MX324042416SL01', N'MX12404120AI01', N'MX324041510O001', N'MX324032921GZ01', N'MX12406212N101', N'MX324012821NH01', N'MX22405086ZK01', N'MX224011517K301', N'MX3240528138N01', N'MX22404241SP01', N'MX32403283G801', N'MX12403209UW01', N'MX324021023UO01', N'MX224011119I701', N'MX124041518D001', N'MX224052779101', N'MX32402246ZW01', N'MX224041113MN01', N'MX32403164AE01', N'MX224032923GU01', N'MX224013020RA01', N'MX124032217WU01', N'MX324042819UG01', N'MX1240526195301', N'MX12403252YM01', N'MX124061417I301', N'MX2240517124901', N'MX224042211S001', N'MX324020123PO01', N'MX3231230149D01', N'MX224032318DV01', N'MX324031509P01', N'MX32405086YZ01', N'MX32402121V701', N'MX324061516FU01', N'MX22404093L501', N'MX324052506R01', N'MX124051818ZW01', N'MX324032611F901', N'MX22401038E701', N'MX124010823IX01', N'MX224032818GA01', N'MX324032023CI01', N'MX224060819EW01', N'MX3240302203X01', N'MX22404184PW01', N'MX224052246O01', N'MX124010320F801', N'MX12403035K701', N'MX32402222YZ01', N'MX124061720KH01', N'MX124061612JJ01', N'MX124061412HW01', N'MX224020223SU01', N'MX22403239DS01', N'MX32402172XF01', N'MX12402294I701', N'MX32402111UP01', N'MX324050821ZE01', N'MX12401191QT01', N'MX124032220WY01', N'MX224061718JN01', N'MX22404190QA01', N'MX1240528186D01', N'MX224061221GW01', N'MX324050112VS01', N'MX124021911CE01', N'MX2240520216201', N'MX124030410L201', N'MX224012518P001', N'MX324032412EC01', N'MX324012614MA01', N'MX3240513151I01', N'MX22402109W101', N'MX324020323QT01', N'MX324050313WP01', N'MX12404245JB01', N'MX324050313WQ01', N'MX124042617KX01', N'MX2240510150S01', N'MX324011223F401', N'MX2240303174I01', N'MX124062113NC01', N'MX224032121D101', N'MX32401222K501', N'MX124041211AT01', N'MX12403151R201', N'MX224020514TS01', N'MX2240520135V01', N'MX32404105LX01', N'MX32404222RF01', N'MX124060522BS01', N'MX124051017UD01', N'MX3240514121V01', N'MX3240312198K01', N'MX324060521C401', N'MX22312310DV01', N'MX22403200C701', N'MX22406166IJ01', N'MX124010815IM01', N'MX324033012HB01', N'MX32406197HQ01', N'MX324020321QS01', N'MX2240527159201', N'MX224060422D401', N'MX2240514172O01', N'MX22403192BL01', N'MX32401212JQ01', N'MX12401269WA01', N'MX12403225WG01', N'MX124011123L201', N'MX32402027PX01', N'MX224042221SA01', N'MX224012512OX01', N'MX124041513CU01', N'MX3240227121L01', N'MX124010519GN01', N'MX1240530127F01', N'MX12405087SR01', N'MX22404032I901', N'MX1240208165O01', N'MX324021215VI01', N'MX3240309146N01', N'MX224040417IZ01', N'MX12406228O001', N'MX12403126PK01', N'MX324051180I01', N'MX32404180PN01', N'MX1240526134W01', N'MX224052678L01', N'MX124021318T01', N'MX224052913A201', N'MX324043019VG01', N'MX324032314DX01', N'MX324042418SM01', N'MX1240520201C01', N'MX224031409701', N'MX224012415OG01', N'MX32403213CL01', N'MX324031569V01', N'MX32406169G601', N'MX3240314189K01', N'MX224041913QH01', N'MX224051894R01', N'MX22403246E301', N'MX224060410CO01', N'MX224052417M01', N'MX32403269F701', N'MX3240531199U01', N'MX12404141BQ01', N'MX224050721ZC01', N'MX3240510220A01', N'MX124053138001', N'MX224060911FB01', N'MX22406120GE01', N'MX124021923CR01', N'MX3231227107901', N'MX2240519195N01', N'MX22403199BS01', N'MX324061919HZ01', N'MX22406110G101', N'MX124052514201', N'MX22404114ME01', N'MX32401246LA01', N'MX224020312T201', N'MX12401175P401', N'MX124030223K001', N'MX224010620FR01', N'MX22406189K101', N'MX32401318ON01', N'MX22401208MA01', N'MX124050321QA01', N'MX124030512LU01', N'MX12406078CN01', N'MX12404295MM01', N'MX2240302164201', N'MX32401282N401', N'MX224021222X801', N'MX124060814DF01', N'MX224030213W01', N'MX224052849901', N'MX32406044BK01', N'MX124031821TQ01', N'MX324042722U001', N'MX224042016R301', N'MX3231228118001', N'MX224013120RS01', N'MX22403305H001', N'MX124010820IU01', N'MX124061023FC01', N'MX32403187BC01', N'MX1240407177I01', N'MX12405117UP01', N'MX224041422OA01', N'MX224012019MJ01', N'MX124051930401', N'MX324041915QA01', N'MX22406224LX01', N'MX2240303214M01', N'MX124010514GI01', N'MX124042222IG01', N'MX32402022PR01', N'MX124042514K401', N'MX22404115MF01', N'MX12404151CF01', N'MX12404261KI01', N'MX224040816L201', N'MX124010718HY01', N'MX324041315N801', N'MX12403257YR01', N'MX224020618UK01', N'MX2240228162W01', N'MX124042020GX01', N'MX1240403174T01', N'MX1240525184L01', N'MX12405019O701', N'MX2240522187201', N'MX324010521BC01', N'MX224031298401', N'MX124052936N01', N'MX224042911VF01', N'MX324062219JI01', N'MX324020410R401', N'MX1240404105701', N'MX224020412TI01', N'MX124061017F401', N'MX32406062C801', N'MX12403014IS01', N'MX324061018DV01', N'MX2240301133P01', N'MX124040666J01', N'MX224062121LR01', N'MX124011311MF01', N'MX324032420EH01', N'MX22401240O301', N'MX324011610H901', N'MX124010810ID01', N'MX1240522122A01', N'MX3240514141X01', N'MX324032817GJ01', N'MX324011418G401', N'MX124042521KD01', N'MX12404263KM01', N'MX224041116MR01', N'MX22402143XR01', N'MX224043017W901', N'MX224011222IN01', N'MX224031918C101', N'MX324060519C301', N'MX22402199ZL01', N'MX124032821101', N'MX224012920QV01', N'MX324030926D01', N'MX324021118V201', N'MX124062513OW01', N'MX22404179PJ01', N'MX324040714KL01', N'MX2240224161E01', N'MX124061813L801', N'MX12406180KO01', N'MX124061218GO01', N'MX12405050QU01', N'MX224021317XN01', N'MX22401218MR01', N'MX32403291GO01', N'MX124020321S01', N'MX124022418FI01', N'MX324011423GA01', N'MX32406170GI01', N'MX124061915M101', N'MX124052795F01', N'MX32404066JX01', N'MX2240513152601', N'MX124042911MS01', N'MX224022631W01', N'MX2240229123901', N'MX124031918UF01', N'MX124030114J201', N'MX324052436G01', N'MX32404183PO01', N'MX2240312148C01', N'MX324060114A401', N'MX124041321BM01', N'MX124011720PS01', N'MX124012320UK01', N'MX1240519100A01', N'MX32401139FF01', N'MX22404233SH01', N'MX2240520165Z01', N'MX22406025BO01', N'MX32404279TU01', N'MX1240525234N01', N'MX2240514222Y01', N'MX12406222NR01', N'MX12406043AT01', N'MX224020620UL01', N'MX32406050BY01', N'MX124041913FS01', N'MX223122917D701', N'MX324041312N701', N'MX124041421CD01', N'MX12405040QC01', N'MX224060719EA01', N'MX324031614AM01', N'MX12402187BT01', N'MX22401225NB01', N'MX224021813ZD01', N'MX324032723FY01', N'MX124012923YV01', N'MX124031517RJ01', N'MX22403296GH01', N'MX124032221X101', N'MX124012417V701', N'MX224060322CH01', N'MX5240322103301', N'MX124040425201', N'MX12401293Y701', N'MX124031321QA01', N'MX12406210N001', N'MX324051954001', N'MX124062216OC01', N'MX324043021VH01', N'MX224032917GQ01', N'MX22403213CP01', N'MX124011919RG01', N'MX12403029JK01', N'MX22406140HG01', N'MX32404263T901', N'MX32401126EN01', N'MX22403249E601', N'MX12401199R201', N'MX224052728X01', N'MX32406093CY01', N'MX324061015DU01', N'MX224041313NK01', N'MX12406203MD01', N'MX2240309186Q01', N'MX1240204162S01', N'MX3240524176M01', N'MX124012917YO01', N'MX124040948K01', N'MX224013018R701', N'MX324042610TE01', N'MX124051621YO01', N'MX2240527189601', N'MX224051794501', N'MX12401292Y601', N'MX22402174YR01', N'MX124051515XQ01', N'MX12403238XD01', N'MX12402287HG01', N'MX324011214EV01', N'MX324042816UD01', N'MX324020219Q601', N'MX22406158I601', N'MX224020217SP01', N'MX1240404135C01', N'MX324041017M301', N'MX124020744L01', N'MX224031618AE01', N'MX22403276FI01', N'MX32404193Q201', N'MX224050821ZT01', N'MX3240521175601', N'MX1240520141301', N'MX32401184I701', N'MX12401062GR01', N'MX324050413X901', N'MX22406221LU01', N'MX324021611X601', N'MX1240207235501', N'MX124050814T101', N'MX12403199U401', N'MX124050518RA01', N'MX2240512121L01', N'MX324032618FD01', N'MX1240527115K01', N'MX224040511JA01', N'MX324051371801', N'MX12401128LB01', N'MX22403172AK01', N'MX324042323S901', N'MX224041214N901', N'MX1240402174D01', N'MX124051322WE01', N'MX1240403214Y01', N'MX32404291UJ01', N'MX324021020UN01', N'MX224011710L001', N'MX12401194QV01', N'MX2240519205O01', N'MX2240509120601', N'MX1240214119H01', N'MX124031223PU01', N'MX12403118OV01', N'MX32404170OU01', N'MX12406109ET01', N'MX124062511OT01', N'MX22405060YP01', N'MX22406139H401', N'MX324020519S301', N'MX324060122AA01', N'MX22402118WF01', N'MX32404307V401', N'MX12406215N401', N'MX124051822ZX01', N'MX124020613S01', N'MX12404305NE01', N'MX124022716H201', N'MX124040707301', N'MX124030817N101', N'MX2240315129T01', N'MX224011515K101', N'MX22405077Z401', N'MX324042017QY01', N'MX224012212NE01', N'MX32406202I201', N'MX32404165OI01', N'MX224020121SC01', N'MX324050318WX01', N'MX324021110UW01', N'MX3231227177D01', N'MX3240526137S01', N'MX224031459801', N'MX32404249SG01', N'MX2240308146101', N'MX32406128EL01', N'MX22403162A401', N'MX324031228601', N'MX12401234TY01', N'MX124012016S601', N'MX3240224220G01', N'MX32404282U201', N'MX224021421Y101', N'MX22404220RV01', N'MX224032915GP01', N'MX12401310ZL01', N'MX124012712X701', N'MX12401231TW01', N'MX1240329182C01', N'MX224061620J001', N'MX124040455401', N'MX12406042AR01', N'MX324020522S401', N'MX324031916BT01', N'MX12403202UN01', N'MX12401074HG01', N'MX124020835A01', N'MX123122916DD01', N'MX2240527169401', N'MX22406114G301', N'MX124010821IV01', N'MX22404190QB01', N'MX224010317EB01', N'MX224050321XI01', N'MX22404026HQ01', N'MX12405095TK01', N'MX22401079FZ01', N'MX22406150I101', N'MX124010817IP01', N'MX12401279X201', N'MX2240518195201', N'MX124050623S101', N'MX124042918N301', N'MX12401046FI01', N'MX124050616RW01', N'MX324010919DF01', N'MX324050618Y601', N'MX124011218LT01', N'MX124010723I001', N'MX2240223130Z01', N'MX22401099H001', N'MX12401290Y301', N'MX1240601128Y01', N'MX12406036A001', N'MX3240514222301', N'MX224053023AT01', N'MX12404277LB01', N'MX124031818TN01', N'MX12405145WN01', N'MX224050411XW01', N'MX22401037E601', N'MX224021320XO01', N'MX32402227Z401', N'MX224060319CC01', N'MX12405021OS01', N'MX224032716FP01', N'MX124012519VT01', N'MX124050220PF01', N'MX32404097LC01', N'MX124061119FS01', N'MX2240510100M01', N'MX124042017GT01', N'MX324011220F001', N'MX124020422F01', N'MX324061011DN01', N'MX12401075HH01', N'MX3240301153901', N'MX22401301R101', N'MX324061411F901', N'MX1240526174Y01', N'MX124052171J01', N'MX224011820LM01', N'MX124011321MR01', N'MX324010618BX01', N'MX224040822L401', N'MX224022681Z01', N'MX124053017901', N'MX224020112S301', N'MX32401080CI01', N'MX324052396401', N'MX224032412EC01', N'MX124030511LP01', N'MX22403280FV01', N'MX124051415WX01', N'MX324032222DI01', N'MX12402260G301', N'MX224012222NN01', N'MX324060119A901', N'MX224030544X01', N'MX124012117T001', N'MX32403251EK01', N'MX32401274MN01', N'MX324011711HS01', N'MX1240207144U01', N'MX124051950601', N'MX324011713HT01', N'MX224032113CV01', N'MX1240327150L01', N'MX12401077HK01', N'MX2240523217L01', N'MX324010412AH01', N'MX22404043IO01', N'MX22401045EJ01', N'MX224010714G001', N'MX32403192BO01', N'MX324012623MK01', N'MX224040521JJ01', N'MX324010921DG01', N'MX22406119G501', N'MX324052526S01', N'MX12403090N801', N'MX224050323XK01', N'MX124042023H201', N'MX22402121WT01', N'MX224011917M001', N'MX12401211SD01', N'MX1240410189Q01', N'MX324012023JK01', N'MX2240518235301', N'MX3240310127701', N'MX12405034PQ01', N'MX124031718ST01', N'MX124061812L601', N'MX2240312238L01', N'MX224042614U301', N'MX224030304A01', N'MX224042318SL01', N'MX1240214159K01', N'MX324051532701', N'MX324052074I01', N'MX12405118UQ01', N'MX324030966G01', N'MX124022020D501', N'MX124041220AZ01', N'MX124031620SA01', N'MX2240519235S01', N'MX124032616ZT01', N'MX124021912CH01', N'MX22406201KX01', N'MX22402133XC01', N'MX12403053LH01', N'MX323123079A01', N'MX1240214189R01', N'MX2240224181F01', N'MX12401184Q101', N'MX2240514102F01', N'MX124010621H901', N'MX124020734I01', N'MX22401301QZ01', N'MX224030504W01', N'MX324060219AK01', N'MX224012616PG01', N'MX12402234EJ01', N'MX324012210KC01', N'MX3240529119101', N'MX124031720SX01', N'MX224020820VF01', N'MX124011020KD01', N'MX32403170AV01', N'MX12406209MK01', N'MX224051533101', N'MX324040416J001', N'MX124012312UC01', N'MX124010515GK01', N'MX22405052Y001', N'MX324042814UC01', N'MX324021914YE01', N'MX1240203152501', N'MX22401116HX01', N'MX224051221A01', N'MX32404210R301', N'MX224040222I401', N'MX1240523213A01', N'MX12405045QI01', N'MX2240222190L01', N'MX124060716CU01', N'MX123122717C601', N'MX224021410XV01', N'MX224060210BP01', N'MX224062111LH01', N'MX12403174SK01', N'MX324012616MB01', N'MX3240531139S01', N'MX12404152CG01', N'MX224041316NO01', N'MX324061823HI01', N'MX324032514ET01', N'MX324061818HD01', N'MX2240511181501', N'MX224041713PK01', N'MX32406200I101', N'MX22406103FP01', N'MX324012320L201', N'MX324052215E01', N'MX223122721CA01', N'MX324031818BJ01', N'MX224060822EX01', N'MX124013112ZW01', N'MX324052336001', N'MX12406118FL01', N'MX123122919DI01', N'MX224042818V401', N'MX2240224221J01', N'MX124051823ZZ01', N'MX124012623WN01', N'MX3240521105301', N'MX224032020CK01', N'MX12402282HA01', N'MX224011212II01', N'MX224011812LF01', N'MX124052332T01', N'MX1240530197P01', N'MX12405174YU01', N'MX22405318B101', N'MX12402297I901', N'MX123123019E601', N'MX224041719PO01', N'MX12401286XJ01', N'MX324020623SW01', N'MX124050821TA01', N'MX32401177HR01', N'MX32403275FM01', N'MX224040517JI01', N'MX22406224LZ01', N'MX123122710BV01', N'MX224041223NC01', N'MX324022811W01', N'MX224060812EQ01', N'MX124012612WD01', N'MX32404252ST01', N'MX124032982001', N'MX2240229203E01', N'MX2240225201S01', N'MX1240328101C01', N'MX32406214IM01', N'MX12403183T601', N'MX3240311208001', N'MX1240214189S01', N'MX124011919RH01', N'MX32402103UI01', N'MX32401064BH01', N'MX32406019A301', N'MX324012518LV01', N'MX32401238KT01', N'MX12401064GU01', N'MX324041514O801', N'MX324032812GG01', N'MX22406061DL01', N'MX224012717PX01', N'MX1240327160M01', N'MX124061623JX01', N'MX324030102Y01', N'MX324012613M801', N'MX12404211H301', N'MX324043023VI01', N'MX32405055XJ01', N'MX324012317KZ01', N'MX324022220ZB01', N'MX1240525144F01', N'MX224041610P601', N'MX12404127AQ01', N'MX224051211901', N'MX22403258ER01', N'MX224042413T001', N'MX224041211N501', N'MX224032115CW01', N'MX324060323BE01', N'MX22405074Z301', N'MX324040421J301', N'MX324040719KP01', N'MX32403296GT01', N'MX3240229132R01', N'MX32403203C201', N'MX124042618KZ01', N'MX22401313RE01', N'MX224012819QE01', N'MX32402161WY01', N'MX324042112R901', N'MX224040812KY01', N'MX12401093J201', N'MX324061612G701', N'MX22404056J801', N'MX224032211DC01', N'MX32406144F401', N'MX3231230239J01', N'MX32404156NX01', N'MX324012122K101', N'MX224021315XJ01', N'MX124041921FZ01', N'MX324012815NC01', N'MX324061820HF01', N'MX3240225160M01', N'MX324020822TR01', N'MX22404065JQ01', N'MX224053123B901', N'MX224021714YY01', N'MX1240528206H01', N'MX32406100DD01', N'MX124031823TR01', N'MX124032518Z201', N'MX324032215DD01', N'MX1240212158L01', N'MX22403238DR01', N'MX224031818BF01', N'MX12401133M201', N'MX12406177K301', N'MX2240517184G01', N'MX22403215CQ01', N'MX324032420EI01', N'MX12404198FM01', N'MX22402025SI01', N'MX224011818LJ01', N'MX32405077YF01', N'MX12403254YN01', N'MX2240314119A01', N'MX224052537Z01', N'MX324052717Z01', N'MX1240531218I01', N'MX32401161GZ01', N'MX124011016K901', N'MX2240303144E01', N'MX32404149NJ01', N'MX12403047L001', N'MX124040143501', N'MX124010814IL01', N'MX2240516203W01', N'MX22406044CI01', N'MX324050115VT01', N'MX22401228NC01', N'MX124013021ZI01', N'MX224040911LH01', N'MX32402060S701', N'MX2240514152N01', N'MX22401041EG01', N'MX2240309106I01', N'MX3231229199101', N'MX3240311147S01', N'MX22401254OS01', N'MX22402083V101', N'MX124042419JQ01', N'MX224041013LZ01', N'MX12406083D401', N'MX32403177B101', N'MX124030912NK01', N'MX224011017HP01', N'MX32403245E701', N'MX124041039801', N'MX1240210106V01', N'MX22401064FH01', N'MX12401178P701', N'MX32404174OV01', N'MX324040122HY01'))
-- Declare the cursor
DECLARE cur CURSOR FOR
    SELECT resultcurve_id FROM #Resultcurve_id_table

-- Open the cursor
OPEN cur

-- Fetch the first row
FETCH NEXT FROM cur INTO @ResultCurveId

-- Loop through the rows
WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Execute the stored procedure for each ResultCurveId and insert the result into the temporary table
        INSERT INTO #ResultsTable
            EXEC dbo.CurveData @ResultCurveId

        -- Fetch the next row
        FETCH NEXT FROM cur INTO @ResultCurveId
    END

-- Close and deallocate the cursor
CLOSE cur
DEALLOCATE cur;

-- Tables des ResultCurve_id de la commande
WITH T AS (
    SELECT Rit.OrderNo, #ResultsTable.ResultCurve_id, n, (xtime/60) AS xtime, (xvalue*10) AS xvalue, Batch, Sample_Code
    FROM #ResultsTable
             JOIN #Resultcurve_id_table Rit ON #ResultsTable.ResultCurve_id = Rit.resultcurve_id
    WHERE n != 0
)
SELECT T.OrderNo, T.Batch, T.Sample_Code, T.xtime, T.xvalue, (T.xvalue - T2.xvalue)/(T.xtime - T2.xtime) AS slope
FROM T, T AS T2
WHERE T.ResultCurve_id = T2.ResultCurve_id AND T.n = T2.n + 1 AND T.xtime > 0.2 AND T.xtime < 0.8 and (T.xtime - T2.xtime) != 0


-- Drop the temporary table
DROP TABLE #ResultsTable
DROP TABLE #Resultcurve_id_table